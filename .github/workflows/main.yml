name: Build workloads

on:
  push:
  pull_request:

jobs:
  cpu:
    name: CPU build & test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Configure CPU targets
        run: cmake -S . -B build/cpu -DCMAKE_BUILD_TYPE=Release -DENABLE_CPU=ON
      - name: Build CPU targets
        run: cmake --build build/cpu --config Release
      - name: Run softmax CPU executables
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t executables < <(find build/cpu -maxdepth 5 -type f -executable -name 'softmax_cpu_*' | sort)
          for exe in "${executables[@]}"; do
            echo "Running ${exe}"
            if [[ "${exe}" == *example* ]]; then
              "${exe}" 512 || true
            else
              "${exe}" 1
              "${exe}" 2
              "${exe}" 4
              "${exe}" 5
              "${exe}" 8
              "${exe}" 16
              "${exe}" 32
              "${exe}" 64
              "${exe}" 128
              "${exe}" 256
              "${exe}" 512
              "${exe}" 1023
              "${exe}" 1024
            fi
          done

  cuda:
    name: CUDA build
    runs-on: ubuntu-latest
    container:
      image: nvidia/cuda:12.3.2-devel-ubuntu22.04
    steps:
      - uses: actions/checkout@v4
      - name: Install build tooling
        run: |
          apt-get update
          apt-get install -y --no-install-recommends build-essential cmake git
          rm -rf /var/lib/apt/lists/*
      - name: Fetch CUTLASS
        run: git clone --depth 1 https://github.com/NVIDIA/cutlass.git third_party/cutlass
      - name: Configure CUDA targets
        run: cmake -S . -B build/cuda -DCMAKE_BUILD_TYPE=Release -DENABLE_CUDA=ON -DCMAKE_CUDA_ARCHITECTURES=75 -DCUTLASS_ROOT="$(pwd)/third_party/cutlass"
      - name: Build CUDA targets
        run: cmake --build build/cuda --config Release

  ascend-sim:
    name: Ascend sim build & run
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/nn-complr-tech/ascendc-community-cann:8.3.rc2
      options: --user root
    steps:
      - uses: actions/checkout@v4
      - name: Configure Ascend targets
        run: cmake -S . -B build/ascend -DCMAKE_BUILD_TYPE=Release -DENABLE_ASCEND=ON
      - name: Build Ascend targets
        run: cmake --build build/ascend --config Release
      - name: Run Ascend softmax (sim)
        run: cmake --build build/ascend --target run_softmax_ascend_all --config Release
      - name: Run Ascend mixed (sim)
        run: cmake --build build/ascend --target run_mixed_ascend_all --config Release
